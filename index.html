<!--
このファイルのライセンスは Boost Software License, Version 1.0. ( http://www.boost.org/LICENSE_1_0.txt ) とします。
-->
<script>
'use strict';
(function()
{
    var objectAssign = function(target, source)
    {
        //  copy from https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/assign#Polyfill
        if (typeof Object.assign !== 'function') {
            (function () {
                Object.assign = function (target) {
                'use strict';
                if (target === undefined || target === null) {
                    throw new TypeError('Cannot convert undefined or null to object');
                }
                var output = Object(target);
                for (var index = 1; index < arguments.length; index++) {
                    var source = arguments[index];
                    if (source !== undefined && source !== null) {
                        for (var nextKey in source) {
                            if (Object.prototype.hasOwnProperty.call(source, nextKey)) {
                                output[nextKey] = source[nextKey];
                            }
                        }
                    }
                }
                return output;
                };
            })();
        }

        Object.assign(target, source);
        return target;
    }
    var showError = function(innerHTML)
    {
        document.body.style = "margin: 0px;";
        var errorDiv = document.createElement("div");
        errorDiv.style = "color: #AA3322; background-color: #442211; font-size: 1.5rem; padding: 0.4rem; text-align: center;";
        errorDiv.innerHTML = innerHTML;
        document.body.appendChild(errorDiv);
    }
    var appendLink = function(args)
    {
        var link = document.createElement("link");
        link.rel = args.rel;
        link.type = args.type;
        link.href = args.href;
        if (undefined !== args.id)
        {
            link.id = args.id;
        }
        document.head.appendChild(link);
    }
    var appendTheme = function(href, id)
    {
        appendLink
        (
            {
                rel: "stylesheet",
                type: "text/css",
                href: href,
                id: id
            }
        );
    }
    var makeAbsoluteUrl = function(base, url)
    {
        var baseParts = base.split("?")[0].split("/");
        if (4 <= baseParts.length && "" !== baseParts[baseParts.length -1])
        {
            // ファイル名部分の除去
            baseParts = baseParts.slice(0, -1);
        }
        if (4 <= baseParts.length && "" === baseParts[baseParts.length -1])
        {
            // 末尾の空要素を除去(しておかないと結合時に余分に / が挟まる)
            baseParts = baseParts.slice(0, -1);
        }
        var urlParts = url.split("/");
        if (0 <= urlParts[0].indexOf(":"))
        {
            //  絶対パスなので base 側は全て破棄
            baseParts = [];
        }
        else
        {
            if ("" === urlParts[0])
            {
                urlParts = urlParts.slice(1);
                if ("" === urlParts[1])
                {
                    //  プロトコルだけ利用
                    baseParts = baseParts.slice(0, 1);
                }
                else
                {
                    //  サーバー名まで利用
                    baseParts = baseParts.slice(0, 3);
                }
            }
            else
            {
                while(true)
                {
                    if ("." === urlParts[0])
                    {
                        urlParts = urlParts.slice(1);
                        continue;
                    }
                    if (".." === urlParts[0])
                    {
                        urlParts = urlParts.slice(1);
                        if (4 <= baseParts.length)
                        {
                            baseParts = baseParts.slice(0, -1);
                        }
                        continue;
                    }
                    break;
                }
            }
        }
        return baseParts.concat(urlParts).join("/");
    };
    var translateLinkWithinPageForRemark = function(source)
    {
        var lines = source.split("\n");
        var anchors = [ ];
        var isInEscape = false;
        var page = 1;
        var isLayout = false;
        lines.forEach
        (
            function(line)
            {
                var trimed_line = line.trim();
                var isEscape = "```" === trimed_line.slice(0, 3);
                if (isEscape)
                {
                    isInEscape = !isInEscape;
                }
                else
                if (!isInEscape)
                {
                    if ("--" === line || "---" === line)
                    {
                        if (!isLayout)
                        {
                            ++page;
                        }
                        isLayout = false;
                    }
                    else
                    if ("#" === trimed_line.slice(0, 1))
                    {
                        var anchor = trimed_line.replace(/^#*/, "").trim().toLowerCase().replace(/[\(\)]/g,"").replace(/ /g,"-");
                        anchors.push
                        (
                            {
                                anchor: "](#" +anchor +")",
                                page: "](#" +page +")"
                            }
                        );
                    }
                    else
                    if ("layout:" === trimed_line.slice(0, 7) && "true" === trimed_line.slice(7).trim())
                    {
                        isLayout = true;
                    }
                }
            }
        );
        isInEscape = false;
        lines = lines.map
        (
            function(line)
            {
                var trimed_line = line.trim();
                var isEscape = "```" === trimed_line.slice(0, 3);
                if (isEscape)
                {
                    isInEscape = !isInEscape;
                }
                else
                if (!isInEscape)
                {
                    anchors.forEach
                    (
                        function(i)
                        {
                            line = line.split(i.anchor).join(i.page);
                        }
                    );
                }
                return line;
            }
        );
        return lines.join("\n");
    };
    var translateLinkWithinPageForReveal = function(source)
    {
        var lines = source.split("\n");
        var anchors = [ ];
        var isInEscape = false;
        var page = 0;
        lines.forEach
        (
            function(line)
            {
                var trimed_line = line.trim();
                var isEscape = "```" === trimed_line.slice(0, 3);
                if (isEscape)
                {
                    isInEscape = !isInEscape;
                }
                else
                if (!isInEscape)
                {
                    if ("--" === line || "---" === line)
                    {
                        ++page;
                    }
                    else
                    if ("#" === trimed_line.slice(0, 1))
                    {
                        var anchor = trimed_line.replace(/^#*/, "").trim().toLowerCase().replace(/[\(\)]/g,"").replace(/ /g,"-");
                        anchors.push
                        (
                            {
                                anchor: "](#" +anchor +")",
                                page: "](#/" +page +")"
                            }
                        );
                    }
                }
            }
        );
        isInEscape = false;
        lines = lines.map
        (
            function(line)
            {
                var trimed_line = line.trim();
                var isEscape = "```" === trimed_line.slice(0, 3);
                if (isEscape)
                {
                    isInEscape = !isInEscape;
                }
                else
                if (!isInEscape)
                {
                    anchors.forEach
                    (
                        function(i)
                        {
                            line = line.split(i.anchor).join(i.page);
                        }
                    );
                }
                return line;
            }
        );
        return lines.join("\n");
    };
    var render = function(renderer, baseUrl, source)
    {
        //  regulate return code
        source = source.replace(/\r\n/g,"\n");

        if (!renderer)
        {
            renderer = /<!--\[RENDERER\]\s*(.*?)\s*-->/.exec(source +"<!--[RENDERER]MARKDOWN-->")[1].toLowerCase();
            console.log("renderer: " +(renderer || "null"));
        }
        var isMarkdown = "markdown" === renderer;
        var isRemark = "remark" === renderer;
        var isReveal = "reveal" === renderer;
        //var isEdit = "edit" === renderer;
        var isEdit = false;
        if (!isMarkdown && !isRemark && !isReveal && !isEdit)
        {
            //var message = "Unknown Rederer Name: \"" +renderer +"\" ( Rederer Names: \"markdown\"(default), \"remark\", \"reveal\", \"edit\" )";
            var message = "Unknown Rederer Name: \"" +renderer +"\" ( Rederer Names: \"markdown\"(default), \"remark\", \"reveal\" )";
            showError(message);
            console.error(message);
            return;
        }

        //  conditional comment
        if (!isEdit)
        {
            source = source
                .replace(/<!--\[MD\]-->([\s\S]*?)<!--\[\/MD\]-->/g, isMarkdown ? "$1": "")
                .replace(/<!--\[NOMD\/\]([\s\S]*?)-->/g, !isMarkdown ? "$1": "")
                .replace(/<!--\[NOMD\]-->([\s\S]*?)<!--\[\/NOMD\]-->/g, !isMarkdown ? "$1": "")
                .replace(/<!--\[REMARK\/\]([\s\S]*?)-->/g, isRemark ? "$1": "")
                .replace(/<!--\[REMARK\]-->([\s\S]*?)<!--\[\/REMARK\]-->/g, isRemark ? "$1": "")
                .replace(/<!--\[NOREMARK\]-->([\s\S]*?)<!--\[\/NOREMARK\]-->/g, !isRemark ? "$1": "")
                .replace(/<!--\[REVEAL\/\]([\s\S]*?)-->/g, isReveal ? "$1": "")
                .replace(/<!--\[REVEAL\]-->([\s\S]*?)<!--\[\/REVEAL\]-->/g, isReveal ? "$1": "")
                .replace(/<!--\[NOREVEAL\]-->([\s\S]*?)<!--\[\/NOREVEAL\]-->/g, !isReveal ? "$1": "");
        }

        //  title
        var title = (source+"<!--[TITLE] -->").split("<!--[TITLE]")[1].split("-->")[0].trim();
        if ("" === title)
        {
            title = source
                .split("\n---\n")[0]
                .replace(/!\[(.*?)\]\(.*?\)/g, "$1")
                .replace(/\[(.*?)\]\(.*?\)/g, "$1")
                .replace(/^#+\s+/mg, "")
                .replace(/\s+/g," ")
                .replace(/<!--.*?-->/g, "")
                .replace(/<.*?>/g, "")
                .trim()
                .slice(0, 64);
        }
        document.title = title
            .replace(/&lt;/, "<")
            .replace(/&gt;/, ">");

        //  favicon
        var favicon = (source+"<!--[FAVICON] -->").split("<!--[FAVICON]")[1].split("-->")[0].trim();
        if (favicon)
        {
            appendLink
            (
                {
                    rel: "shortcut icon",
                    type: "image/x-icon",
                    href: makeAbsoluteUrl(baseUrl, favicon)
                }
            );
        }

        //  theme
        var themes = (source+"<!--[THEME] -->").split("<!--[THEME]")
            .slice(1)
            .map
            (
                function(i)
                {
                    return i.split("-->")[0].trim();
                }
            )
            .filter(function(i) { return "" !== i });
        if (!isReveal)
        {
            themes.forEach
            (
                function(i)
                {
                    appendTheme(makeAbsoluteUrl(baseUrl, i));
                }
            );
        }

        //  style
        if (!isReveal)
        {
            var style = document.createElement("style");
            style.innerHTML = (source+"<!--[STYLE] -->").split("<!--[STYLE]")[1].split("-->")[0].trim();
            document.head.appendChild(style);
        }

        if (isMarkdown)
        {
            //  marked
            appendTheme("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css");
            if (0 === themes.length)
            {
                appendTheme("theme/default.css");
            }
            var markedScript = document.createElement("script");
            markedScript.src = "js/marked.js";
            markedScript.onload = function()
            {
                var config = JSON.parse((source+"<!--[MARKED-CONFIG] { } -->").split("<!--[MARKED-CONFIG]")[1].split("-->")[0].trim());
                console.log("marked-config: " +JSON.stringify(config, null, 4));
                marked.setOptions(config);

                document.body.className = "marked";
                document.body.innerHTML = marked(source);

                //  highlight
                var highlightScript = document.createElement("script");
                highlightScript.src = "//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js";
                highlightScript.onload = function()
                {
                    hljs.initHighlightingOnLoad();
                };
                document.head.appendChild(highlightScript);
            };
            document.head.appendChild(markedScript);
        }
        if (isRemark)
        {
            //  remark
            var script = document.createElement("script");
            script.src = "js/remark-latest.min.js";
            script.onload = function()
            {
                var config = JSON.parse((source+"<!--[REMARK-CONFIG] { } -->").split("<!--[REMARK-CONFIG]")[1].split("-->")[0].trim());
                config.source = translateLinkWithinPageForRemark(source);
                var slideshow = remark.create(config);
            };
            document.head.appendChild(script);
        }
        if (isReveal)
        {
            //  reveal
            appendTheme("css/reveal.css");
            var revealTheme = /<!--\[REVEAL-THEME\]\s*(.*?)\s*-->/.exec(source +"<!--[REVEAL-THEME]league-->")[1].toLowerCase();
            console.log("reveal-theme: " +revealTheme);
            appendTheme("css/theme/" +revealTheme +".css", "theme");
            var documentTheme = document.getElementById("theme");
            appendTheme("lib/css/zenburn.css");
            appendTheme(window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css');

            themes.forEach
            (
                function(i)
                {
                        appendTheme(makeAbsoluteUrl(baseUrl, i));
                }
            );
            var style = document.createElement("style");
            style.innerHTML = (source+"<!--[STYLE] -->").split("<!--[STYLE]")[1].split("-->")[0].trim();
            document.head.appendChild(style);

            //  paste markdown
            var separator = (source+"<!--[REVEAL-SEPARATOR] ^\\n---$ -->").split("<!--[REVEAL-SEPARATOR]")[1].split("-->")[0].trim();
            var separator_vertical = (source+"<!--[REVEAL-SEPARATOR-VERTICAL] ^\\n>>>$ -->").split("<!--[REVEAL-SEPARATOR-VERTICAL]")[1].split("-->")[0].trim();
            var separator_notes = (source+"<!--[REVEAL-SEPARATOR-NOTES] ^Note: -->").split("<!--[REVEAL-SEPARATOR-NOTES]")[1].split("-->")[0].trim();
            var pasteMarkdown = function(markdown)
            {
                var div = document.createElement("div");
                div.className = "reveal";
                div.innerHTML =
                    "<div class=\"slides\">"
                        +"<section id=\"source-markdown\" data-markdown>"
                            +"<script type=\"text/template\">"
                                +markdown
                            +"</" +"script>"
                        +"</section>"
                    +"</div>";
                document.body.appendChild(div);
                var section = document.getElementById("source-markdown");
                section.setAttribute("data-separator", separator);
                section.setAttribute("data-separator-vertical", separator_vertical);
                section.setAttribute("data-separator-notes", separator_notes);
                section.removeAttribute("id");
            };
            pasteMarkdown(translateLinkWithinPageForReveal(source));
            var headScript = document.createElement("script");
            headScript.src = "lib/js/head.min.js";
            headScript.onload = function()
            {
                var script = document.createElement("script");
                script.src = "js/reveal.js";
                script.onload = function()
                {
                    var revealTransition = /<!--\[REVEAL-TRANSITION\]\s*(.*?)\s*-->/.exec(source +"<!--[REVEAL-TRANSITION]concave-->")[1].toLowerCase();
                    console.log("reveal-transition: " +revealTransition);
                    console.log("reveal-theme(forced by url param): " +Reveal.getQueryHash().theme);
                    console.log("reveal-transition(forced by url param): " +Reveal.getQueryHash().transition);
                    var forceTheme = Reveal.getQueryHash().theme;
                    if (forceTheme)
                    {
                        documentTheme.href = "css/theme/" +forceTheme +".css";
                    }
                    // More info about config & dependencies:
                    // - https://github.com/hakimel/reveal.js#configuration
                    // - https://github.com/hakimel/reveal.js#dependencies
                    var config = JSON.parse((source+"<!--[REVEAL-CONFIG] { } -->").split("<!--[REVEAL-CONFIG]")[1].split("-->")[0].trim());
                    console.log("reveal-config: " +JSON.stringify(config, null, 4));
                    var defaultConfig =
                    {
                        controls: true,
                        progress: true,
                        history: true,
                        center: true,
                        transition: Reveal.getQueryHash().transition || revealTransition, 
                        dependencies:
                        [
                            { src: 'plugin/markdown/marked.js' },
                            { src: 'plugin/markdown/markdown.js' },
                            { src: 'plugin/notes/notes.js', async: true },
                            { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                        ]
                    };
                    Reveal.initialize(objectAssign(defaultConfig, config));
                };
                document.head.appendChild(script);
            };
            document.head.appendChild(headScript);
        }
    }
    var renderer = null; 
    var sourceUrl = null;
    var urlArgs = (location.href.split("#")[0] +"?")
        .split("?")[1]
        .split("&")
        .filter(function(i) { return i.indexOf("=") < 0 })
        .map(function(i) { return unescape(decodeURI(i));});
    if (1 <= urlArgs.length)
    {
        if (2 <= urlArgs.length)
        {
            renderer = urlArgs[0];
            sourceUrl = urlArgs[1];
        }
        else
        {
            sourceUrl = urlArgs[0];
        }
    }
    if (!sourceUrl)
    {
        sourceUrl = "index.md";
    }
    console.log("renderer(forced by url param): " +(renderer || "null"));
    console.log("loading: " +sourceUrl);
    if ("text:" === sourceUrl.slice(0, 5))
    {
        setTimeout(function(){
            render(renderer, location.href, sourceUrl.slice(5));
        }, 1); // 0 だと document.body が null だと怒られることがある。
    }
    else
    {
        var request = window.XMLHttpRequest ? new XMLHttpRequest(): new ActiveXObject("Microsoft.XMLHTTP");
        request.open('GET', sourceUrl, true);
        request.onreadystatechange = function()
        {
            if (4 === request.readyState)
            {
                if (200 <= request.status && request.status < 300)
                {
                    render(renderer, makeAbsoluteUrl(location.href, sourceUrl), request.responseText);
                }
                else
                {
                    showError("loading failed: { \"method\": \"GET\", \"url\": \"<a href=\"" +sourceUrl.replace(/\"/g, "%25") +" \" style=\"color: #6666FF;\">" + sourceUrl.replace(/</g, "&lt;").replace(/>/g, "&gt;") +"</a>\", \"status\": "+ request.status + "};");
                    document.body.appendChild(errorDiv);
                    var responseDiv = document.createElement("div");
                    if (request.responseText)
                    {
                        responseDiv.innerHTML = request.responseText;
                    }
                    else
                    {
                        responseDiv.style = "white-space: pre-wrap; font-size: 1.5rem; padding: 20px;"
                        if (0 === request.status)
                        {
                            responseDiv.innerText = "There ia a possibility that server not found or it happened cross-domain issue.\nサーバーが見つからないかクロスドメインの問題が発生した可能性があります。";
                        }
                        else
                        {
                            responseDiv.innerText = JSON.stringify(request.getAllResponseHeaders(), null, 4);
                        }
                    }
                    document.body.appendChild(responseDiv);
                }
            }
        };
        request.send(null);
    }
})();
</script>
