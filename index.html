<!--
このファイルのライセンスは Boost Software License, Version 1.0. ( http://www.boost.org/LICENSE_1_0.txt ) とします。
-->
<script src="js/remark-latest.min.js"></script>
<!--
このファイルだけコピペして動かすには上の script タグをコメントアウトし、下の script タグのコメントアウトを解除してください。
-->
<!-- script src="https://remarkjs.com/downloads/remark-latest.min.js"></script -->
<script>
(function()
{
    var makeAbsoluteUrl = function(base, url)
    {
        var baseParts = base.split("?")[0].split("/");
        if (4 <= baseParts.length && "" !== baseParts[baseParts.length -1])
        {
            // ファイル名部分の除去
            baseParts = baseParts.slice(0, -1);
        }
        if (4 <= baseParts.length && "" === baseParts[baseParts.length -1])
        {
            // 末尾の空要素を除去(しておかないと結合時に余分に / が挟まる)
            baseParts = baseParts.slice(0, -1);
        }
        var urlParts = url.split("/");
        if (0 <= urlParts[0].indexOf(":"))
        {
            //  絶対パスなので base 側は全て破棄
            baseParts = [];
        }
        else
        {
            if ("" === urlParts[0])
            {
                urlParts = urlParts.slice(1);
                if ("" === urlParts[1])
                {
                    //  プロトコルだけ利用
                    baseParts = baseParts.slice(0, 1);
                }
                else
                {
                    //  サーバー名まで利用
                    baseParts = baseParts.slice(0, 3);
                }
            }
            else
            {
                while(true)
                {
                    if ("." === urlParts[0])
                    {
                        urlParts = urlParts.slice(1);
                        continue;
                    }
                    if (".." === urlParts[0])
                    {
                        urlParts = urlParts.slice(1);
                        if (4 <= baseParts.length)
                        {
                            baseParts = baseParts.slice(0, -1);
                        }
                        continue;
                    }
                    break;
                }
            }
        }
        return baseParts.concat(urlParts).join("/");
    };
    var translateLinkWithinPage = function(source)
    {
        var lines = source.split("\n");
        var anchors = [ ];
        var isInEscape = false;
        var page = 1;
        var isLayout = false;
        lines.forEach
        (
            function(line)
            {
                var trimed_line = line.trim();
                var isEscape = "```" === trimed_line.slice(0, 3);
                if (isEscape)
                {
                    isInEscape = !isInEscape;
                }
                else
                if (!isInEscape)
                {
                    if ("--" === line || "---" === line)
                    {
                        if (!isLayout)
                        {
                            ++page;
                        }
                        isLayout = false;
                    }
                    else
                    if ("#" === trimed_line.slice(0, 1))
                    {
                        var anchor = trimed_line.replace(/^#*/, "").trim().toLowerCase().replace(/[\(\)]/g,"").replace(/ /g,"-");
                        anchors.push
                        (
                            {
                                anchor: "](#" +anchor +")",
                                page: "](#" +page +")"
                            }
                        );
                    }
                    else
                    if ("layout:" === trimed_line.slice(0, 7) && "true" === trimed_line.slice(7).trim())
                    {
                        isLayout = true;
                    }
                }
            }
        );
        isInEscape = false;
        lines = lines.map
        (
            function(line)
            {
                var trimed_line = line.trim();
                var isEscape = "```" === trimed_line.slice(0, 3);
                if (isEscape)
                {
                    isInEscape = !isInEscape;
                }
                else
                if (!isInEscape)
                {
                    anchors.forEach
                    (
                        function(i)
                        {
                            line = line.split(i.anchor).join(i.page);
                        }
                    );
                }
                return line;
            }
        );
        return lines.join("\n");
    };
    var sourceUrl = makeAbsoluteUrl(location.href, unescape((location.href.split("#")[0] +"?index.md").split("?")[1]));
    console.log("loading: " +sourceUrl);
    var request = window.XMLHttpRequest ? new XMLHttpRequest(): new ActiveXObject("Microsoft.XMLHTTP");
    request.open('GET', sourceUrl, true);
    request.onreadystatechange = function()
    {
        if (4 === request.readyState)
        {
            if (200 <= request.status && request.status < 300)
            {
                //  source
                var source = request.responseText.replace(/\r\n/g,"\n");

                //  conditional comment
                source = source
                    .replace(/<!--\[NOMD\](.*)-->/g, "$1")
                    .replace(/<!--\[MD\]-->(.*)<!--\[\/MD\]-->/g, "")
                    .replace(/<!--\[REMARK\](.*)-->/g, "$1")
                    .replace(/<!--\[NOREMARK\]-->(.*)<!--\[\/NOREMARK\]-->/g, "")
                    .replace(/<!--\[REVEAL\](.*)-->/g, "")
                    .replace(/<!--\[NOREVEAL\]-->(.*)<!--\[\/NOREVEAL\]-->/g, "$1");

                //  title
                var title = (source+"<!--[TITLE] -->").split("<!--[TITLE]")[1].split("-->")[0].trim();
                if ("" === title)
                {
                    var sourceUrlParts = sourceUrl.split("/");
                    title = sourceUrlParts[sourceUrlParts.length -1];
                    if ("" === title)
                    {
                        title = sourceUrlParts[sourceUrlParts.length -2];
                    }
                    if ("" === title)
                    {
                        title = sourceUrl;
                    }
                }
                document.title = title;

                //  favicon
                var favicon = (source+"<!--[FAVICON] -->").split("<!--[FAVICON]")[1].split("-->")[0].trim();
                if (favicon)
                {
                    var link = document.createElement("link");
                    link.rel = "shortcut icon";
                    link.type = "image/x-icon";
                    link.href = makeAbsoluteUrl(sourceUrl, favicon);
                    document.head.appendChild(link);
                }

                //  theme
                (source+"<!--[THEME] -->").split("<!--[THEME]").slice(1).forEach
                (
                    function(i)
                    {
                        var theme = i.split("-->")[0].trim();
                        if (theme)
                        {
                            var link = document.createElement("link");
                            link.rel = "stylesheet";
                            link.type = "text/css";
                            link.href = makeAbsoluteUrl(sourceUrl, theme);
                            document.head.appendChild(link);
                        }
                    }
                );

                //  style
                var style = document.createElement("style");
                style.innerHTML = (source+"<!--[STYLE] -->").split("<!--[STYLE]")[1].split("-->")[0].trim();
                document.head.appendChild(style);

                //  remark
                var config = JSON.parse((source+"<!--[REMARK-CONFIG] { } -->").split("<!--[REMARK-CONFIG]")[1].split("-->")[0].trim());
                config.source = translateLinkWithinPage(source);
                var slideshow = remark.create(config);
            }
            else
            {
                document.body.style = "margin: 0px;";
                var errorDiv = document.createElement("div");
                errorDiv.style = "color: #AA3322; background-color: #442211; font-size: 1.5rem; padding: 0.4rem; text-align: center;";
                errorDiv.innerHTML = "loading failed: { \"method\": \"GET\", \"url\": \"<a href=\"" +sourceUrl.replace(/\"/g, "%25") +" \" style=\"color: #6666FF;\">" + sourceUrl.replace(/</g, "&lt;").replace(/>/g, "&gt;") +"</a>\", \"status\": "+ request.status + "};";
                document.body.appendChild(errorDiv);
                var responseDiv = document.createElement("div");
                if (request.responseText)
                {
                    responseDiv.innerHTML = request.responseText;
                }
                else
                {
                    responseDiv.style = "white-space: pre-wrap; font-size: 1.5rem; padding: 20px;"
                    if (0 === request.status)
                    {
                        responseDiv.innerText = "There ia a possibility that server not found or it happened cross-domain issue.\nサーバーが見つからないかクロスドメインの問題が発生した可能性があります。";
                    }
                    else
                    {
                        responseDiv.innerText = JSON.stringify(request.getAllResponseHeaders(), null, 4);
                    }
                }
                document.body.appendChild(responseDiv);
            }
        }
    };
    request.send(null);
})();
</script>
